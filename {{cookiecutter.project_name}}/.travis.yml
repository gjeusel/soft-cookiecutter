language: python

python:
  - 3.7

install:
  - pip install -U pip wheel
  - pip install -r requirements-dev.txt
  - pip install -r requirements.txt
  - pip install .

cache:
  directories:
    - $HOME/.cache/pip

stages:
  - test
  - linter
  - name: deploy
    if: tag IS present

jobs:
  include:

    - stage: test
      name: "Tests"
      script: pytest --cov-report=term-missing --cov={{ cookiecutter.project_slug }}
      after_success:
        - codecov

    - stage: linter
      name: "Linter"
      script: pre-commit run --all-files --show-diff-on-failure

    - stage: deploy
      name: "PyPI Deploy"
      script: skip
      install: skip
      before_install: skip
      deploy:
        skip_cleanup: true
        provider: pypi
        distributions: sdist bdist_wheel
        user: {{ cookiecutter.pypi_username }}
        on:
          tags: true
          repo: {{ cookiecutter.github_username }}/{{ cookiecutter.project_name }}
        password:
          secure: "REPLACE ME USING CMDLINE"

# Let travis-ci CLI tool encrypt your password for PyPI deployment:
# > gem install travis
# > travis encrypt --add deploy.password --com
